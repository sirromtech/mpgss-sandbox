{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Continuing Student Application</h2>

    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="accordion" id="continuingAccordion">

            <!-- PROFILE (EDITABLE) -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingProfile">
                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseProfile" aria-expanded="true"
                        aria-controls="collapseProfile">
                  Your Profile (Editable)
                </button>
              </h2>

              <div id="collapseProfile" class="accordion-collapse collapse show"
                   aria-labelledby="headingProfile" data-bs-parent="#continuingAccordion">
                <div class="accordion-body">
                  {{ profile_form.non_field_errors }}

                  <div class="row g-3">
                    <div class="col-md-6">{{ profile_form.first_name|as_crispy_field }}</div>
                    <div class="col-md-6">{{ profile_form.surname|as_crispy_field }}</div>

                    <div class="col-md-4">{{ profile_form.gender|as_crispy_field }}</div>
                    <div class="col-md-4">{{ profile_form.phone_number|as_crispy_field }}</div>
                    <div class="col-md-4">{{ profile_form.active_student_id|as_crispy_field }}</div>

                    <div class="col-md-6">{{ profile_form.origin_province|as_crispy_field }}</div>
                    <div class="col-md-6">{{ profile_form.origin_district|as_crispy_field }}</div>
                    <div class="col-md-6">{{ profile_form.origin_ward|as_crispy_field }}</div>

                    <div class="col-md-6">{{ profile_form.current_residential_area|as_crispy_field }}</div>
                    <div class="col-md-6">{{ profile_form.current_district|as_crispy_field }}</div>
                    <div class="col-md-6">{{ profile_form.current_llg|as_crispy_field }}</div>

                    <div class="col-md-12">{{ profile_form.postal_address|as_crispy_field }}</div>

                    <div class="col-md-6">
                      {{ profile_form.photo|as_crispy_field }}
                      <div class="form-text">Upload a clear passport-size photo (JPG/PNG). Max 10MB.</div>
                      <div id="profilePhotoPreview" class="mt-2"></div>
                    </div>

                    {% if profile.photo %}
                    <div class="col-md-6">
                      <div class="text-muted small mb-1">Current photo</div>
                      <img src="{{ profile.photo.url }}" class="img-thumbnail" style="max-width:220px;" alt="Profile photo">
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>


            <!-- APPLICATION DETAILS -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingApp">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseApp" aria-expanded="false"
                            aria-controls="collapseApp">
                        Application Details
                    </button>
                </h2>

                <div id="collapseApp" class="accordion-collapse collapse"
                     aria-labelledby="headingApp" data-bs-parent="#continuingAccordion">
                    <div class="accordion-body">

                        {{ form.non_field_errors }}

                        <div class="row g-3">

                            <!-- Institution and Course are taken from lookup (READ-ONLY) -->
                            <div class="col-md-6">
                                <label class="form-label">Institution</label>
                                <input class="form-control"
                                       value="{% if application.institution %}{{ application.institution.name }}{% else %}-{% endif %}"
                                       readonly>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Course</label>
                                <input class="form-control"
                                       value="{% if application.course %}{{ application.course.name }}{% else %}-{% endif %}"
                                       readonly>
                            </div>

<!-- Editable -->
<div class="col-md-4">
    {{ form.year_of_study|as_crispy_field }}
</div>

<h5 class="mt-4">Required Documents</h5>

<div class="col-md-12">
    {{ form.documents_pdf|as_crispy_field }}
    <small class="text-muted">
        Upload all required documents as <strong>one PDF</strong> (max 10MB).
    </small>
</div>


                            </div>
                        </div>
                    </div>
                </div>
            </div>

               

        <div class="mt-4">
            <button type="submit" class="btn btn-primary">Submit Application</button>
        </div>

    </form>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const institutionField = document.getElementById("id_institution");
    const courseField = document.getElementById("id_course");

    institutionField.addEventListener("change", function () {
        const institutionId = this.value;

        fetch(`/institutions/get-courses/${institutionId}/`)
            .then(response => response.json())
            .then(data => {
                courseField.innerHTML = "";
                data.forEach(course => {
                    const option = document.createElement("option");
                    option.value = course.id;
                    option.textContent = course.name;
                    courseField.appendChild(option);
                });
            });
    });
});

function previewPDF(input, previewId) {
    const file = input.files[0];
    if (file && file.type === "application/pdf") {
        const fileURL = URL.createObjectURL(file);
        document.getElementById(previewId).innerHTML =
            `<embed src="${fileURL}" type="application/pdf" width="100%" height="400px" />`;
    }
}


function previewImage(input, previewId) {
    const file = input.files[0];
    if (file && file.type.startsWith("image/")) {
        const fileURL = URL.createObjectURL(file);
        document.getElementById(previewId).innerHTML =
            `<img src="${fileURL}" alt="Profile Photo" class="img-thumbnail" style="max-width:200px;">`;
    }
}


</script>

{% endblock %}
