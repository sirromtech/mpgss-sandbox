{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}Officer Review — New Applicant{% endblock %}

{% block content %}
<div class="container mt-4">

  {# ===== Header + Photo Preview ===== #}
  <div class="card shadow-sm mb-3">
    <div class="card-body d-flex flex-wrap align-items-center gap-3">

      {# Photo: application.face_photo -> profile.photo -> fallback #}
      {% if application.face_photo %}
        <img src="{{ application.face_photo.url }}" alt="Application Photo"
             class="rounded-circle" style="width:90px;height:90px;object-fit:cover;">
      {% elif profile.photo %}
        <img src="{{ profile.photo.url }}" alt="Profile Photo"
             class="rounded-circle" style="width:90px;height:90px;object-fit:cover;">
      {% else %}
        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center"
             style="width:90px;height:90px;">
          <strong style="font-size:28px;">
            {{ profile.first_name|default:student.first_name|slice:":1" }}
          </strong>
        </div>
      {% endif %}

      <div class="flex-grow-1">
        <div class="d-flex flex-wrap align-items-center gap-2">
          <h4 class="mb-0">{{ profile.first_name }} {{ profile.surname }}</h4>
          <span class="badge bg-primary">New Applicant</span>

          {% if application.status %}
            <span class="badge
              {% if application.status == 'APPROVED' %} bg-success
              {% elif application.status == 'REJECTED' %} bg-danger
              {% else %} bg-warning text-dark {% endif %}">
              {{ application.status }}
            </span>
          {% endif %}
        </div>

        <div class="text-muted small">
          Email: {{ student.email }}
          {% if profile.phone_number %} • Phone: {{ profile.phone_number }}{% endif %}
        </div>

        <div class="text-muted small">
          Application ID: <strong>{{ application.unique_id }}</strong>
          {% if application.submission_date %} • Submitted: {{ application.submission_date|date:"d M Y" }}{% endif %}
        </div>

        {% if not application.face_photo and not profile.photo %}
          <div class="text-danger small mt-1">
            ⚠️ No photo uploaded. Student must upload a profile/application photo for officer preview.
          </div>
        {% endif %}
      </div>

      <div class="text-end">
        <a class="btn btn-outline-secondary btn-sm"
           href="{% url 'applications:officer_view_student_profile' profile.pk %}">
          View Student Profile
        </a>
      </div>
    </div>
  </div>

  {# ===== Tabs ===== #}
  <ul class="nav nav-tabs mb-3" id="reviewTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-app" data-bs-toggle="tab" data-bs-target="#pane-app"
              type="button" role="tab">Application Form</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-docs" data-bs-toggle="tab" data-bs-target="#pane-docs"
              type="button" role="tab">Documents</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-review" data-bs-toggle="tab" data-bs-target="#pane-review"
              type="button" role="tab">Review & History</button>
    </li>
  </ul>

  <div class="tab-content">

{# ===== Application Form (read-only display) ===== #}
<div class="tab-pane fade show active" id="pane-app" role="tabpanel" aria-labelledby="tab-app">

  {# --- Program / Study info (keep this) --- #}
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h5 class="mb-3">Study Details</h5>

      <div class="row g-3">
        <div class="col-md-4">
          <div class="text-muted small">Institution</div>
          <div class="fw-semibold">{% if application.institution %}{{ application.institution.name }}{% else %}—{% endif %}</div>
        </div>

        <div class="col-md-4">
          <div class="text-muted small">Course</div>
          <div class="fw-semibold">{% if application.course %}{{ application.course.name }}{% else %}—{% endif %}</div>
        </div>

        <div class="col-md-4">
          <div class="text-muted small">Year of Study</div>
          <div class="fw-semibold">{{ application.year_of_study|default:"—" }}</div>
        </div>
      </div>
    </div>
  </div>

  {# --- Full profile details (NEW) --- #}
  {% for section_title, items in detail_sections %}
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5 class="mb-3">{{ section_title }}</h5>
        <div class="row g-3">
          {% for label, value in items %}
            <div class="col-md-4">
              <div class="text-muted small">{{ label }}</div>
              <div class="fw-semibold">{{ value|default:"—" }}</div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endfor %}


          <hr class="my-3">

          <h6 class="mb-2">Payment Summary</h6>
          <div class="row g-3">
            <div class="col-md-4">
              <div class="text-muted small">Paid</div>
              <div class="fw-semibold">PGK {{ payment.total_paid|default:"0.00" }}</div>
            </div>
            <div class="col-md-4">
              <div class="text-muted small">Balance</div>
              <div class="fw-semibold">PGK {{ payment.balance|default:"0.00" }}</div>
            </div>
            <div class="col-md-4">
              <div class="text-muted small">Status</div>
              <div class="fw-semibold">{{ payment.payment_status|default:"Unpaid" }}</div>
            </div>
          </div>

        </div>
      </div>
    </div>

    {# ===== Documents ===== #}
    <div class="tab-pane fade" id="pane-docs" role="tabpanel" aria-labelledby="tab-docs">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Uploaded Documents</h5>
            <small class="text-muted">Use View/Download • PDF previews are embedded</small>
          </div>
          <hr class="my-3">

          <div class="row g-3">
            {% for label, file in documents %}
              <div class="col-md-6">
                <div class="border rounded p-3 h-100">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="fw-semibold">{{ label }}</div>
                    {% if file %}<span class="badge bg-success">Submitted</span>{% else %}<span class="badge bg-danger">Missing</span>{% endif %}
                  </div>

                  {% if file %}
                    <div class="mt-2 d-flex gap-2">
                      <a class="btn btn-outline-primary btn-sm" href="{{ file.url }}" target="_blank">View</a>
                      <a class="btn btn-outline-secondary btn-sm" href="{{ file.url }}" download>Download</a>
                    </div>

                    <div class="mt-3">
                      {% with url=file.url %}
                        {% if url|lower|slice:"-4:" == ".pdf" %}
                          <embed src="{{ url }}" type="application/pdf" width="100%" height="360px" />
                        {% else %}
                          <img src="{{ url }}" alt="{{ label }}" class="img-fluid rounded border" />
                        {% endif %}
                      {% endwith %}
                    </div>
                  {% else %}
                    <div class="text-muted small mt-2">No file uploaded.</div>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>

        </div>
      </div>
    </div>

    {# ===== Review & History ===== #}
    <div class="tab-pane fade" id="pane-review" role="tabpanel" aria-labelledby="tab-review">
      <div class="row g-3">

        <div class="col-lg-5">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="mb-3">Submit Review</h5>

              <form method="post" novalidate>
                {% csrf_token %}
                {{ form.non_field_errors }}
                {{ form.status|as_crispy_field }}
                {{ form.note|as_crispy_field }}

                <button type="submit" class="btn btn-primary">Save Review</button>
                <a href="{% url 'applications:review_list' %}" class="btn btn-link">Back to review list</a>
              </form>

              <div class="text-muted small mt-3">
                Saving creates a timestamped log (reviewer + note).
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-7">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="mb-3">Review History</h5>

              {% if reviews %}
                <ul class="list-group">
                  {% for r in reviews %}
                    <li class="list-group-item">
                      <div class="d-flex justify-content-between">
                        <div class="fw-semibold">{{ r.get_status_display|default:r.status }}</div>
                        <div class="text-muted small">{{ r.created_at|date:"d M Y H:i" }}</div>
                      </div>
                      <div class="text-muted small">
                        By: {{ r.reviewer.get_full_name|default:r.reviewer.username }}
                      </div>
                      {% if r.note %}
                        <div class="mt-2">{{ r.note }}</div>
                      {% else %}
                        <div class="mt-2 text-muted small">No note provided.</div>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <div class="text-muted">No reviews yet.</div>
              {% endif %}

            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>
{% endblock %}
